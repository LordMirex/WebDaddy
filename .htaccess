# .htaccess – FINAL PRODUCTION VERSION (Performance + Security + Correct Routing)
Options -Indexes
DirectoryIndex index.php index.html

# ------------------------------------------------------------------
# 1. Force HTTPS + non-www (change to your domain)
# ------------------------------------------------------------------
RewriteEngine On
RewriteBase /

RewriteCond %{HTTPS} off [OR]
RewriteCond %{HTTP_HOST} ^www\. [NC]
RewriteRule ^ https://webdaddy.online%{REQUEST_URI} [L,R=301,NE]

# ------------------------------------------------------------------
# 2. Remove trailing slashes (except real directories)
# ------------------------------------------------------------------
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.+)/$ /$1 [R=301,L]

# ------------------------------------------------------------------
# 3. Block sensitive directories
# ------------------------------------------------------------------
RewriteRule ^(includes|database|uploads/private)/ - [F,L]

# ------------------------------------------------------------------
# 4. Serve REAL files & folders directly (CSS, JS, images, assets/, admin/, api/, etc.)
# ------------------------------------------------------------------
RewriteCond %{REQUEST_FILENAME} -f [OR]
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]

# ------------------------------------------------------------------
# 5. Sitemap routing
# ------------------------------------------------------------------
RewriteRule ^sitemap\.xml$ sitemap.php [L]
RewriteRule ^sitemap/?$ sitemap.php [L]

# ------------------------------------------------------------------
# 6. Template slug routing → template.php?slug=name
#     (only triggers if file/folder doesn't exist)
# ------------------------------------------------------------------
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^([a-zA-Z0-9_-]+)/?$ template.php?slug=$1 [QSA,L]

# ------------------------------------------------------------------
# 7. Everything else → index.php
# ------------------------------------------------------------------
RewriteRule ^ index.php [QSA,L]

# ------------------------------------------------------------------
# Security: Deny sensitive files
# ------------------------------------------------------------------
<FilesMatch "\.(env|sql|bak|log|ini|conf|yml|yaml|sh|bat|md|git|htaccess|php~)$">
    Require all denied
</FilesMatch>

# ------------------------------------------------------------------
# Security Headers (same as your original + improved CSP)
# ------------------------------------------------------------------
<IfModule mod_headers.c>
    Header set X-Content-Type-Options "nosniff"
    Header set X-Frame-Options "SAMEORIGIN"
    Header set X-XSS-Protection "1; mode=block"
    Header set Referrer-Policy "strict-origin-when-cross-origin"
    Header set Strict-Transport-Security "max-age=31536000; includeSubDomains" env=HTTPS
    
    # Your original CSP + added blob: for some JS features + googletagmanager if you use analytics
    Header set Content-Security-Policy "default-src 'self' https://cdn.jsdelivr.net https://wa.me; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://www.googletagmanager.com; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; img-src 'self' data: https: blob:; font-src 'self' https://cdn.jsdelivr.net; frame-ancestors 'self';"
</IfModule>

# ------------------------------------------------------------------
# Aggressive Caching (1 year + immutable) – EXACTLY like your old one
# ------------------------------------------------------------------
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresDefault "access plus 1 month"

    ExpiresByType text/css                      "access plus 1 year"
    ExpiresByType application/javascript        "access plus 1 year"
    ExpiresByType image/svg+xml                 "access plus 1 year"
    ExpiresByType image/webp                    "access plus 1 year"
    ExpiresByType image/png                     "access plus 1 year"
    ExpiresByType image/jpeg                    "access plus 1 year"
    ExpiresByType image/gif                     "access plus 1 year"
    ExpiresByType video/mp4                     "access plus 1 year"
    ExpiresByType font/woff2                    "access plus 1 year"
    ExpiresByType font/woff                     "access plus 1 year"
</IfModule>

<IfModule mod_headers.c>
    <FilesMatch "\.(css|js|woff2?|ttf|otf|svg|png|jpe?g|gif|webp|ico|mp4|webm)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </FilesMatch>
    <FilesMatch "\.(php|html?)$">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
    </FilesMatch>
</IfModule>

# ------------------------------------------------------------------
# Gzip Compression
# ------------------------------------------------------------------
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/css application/javascript application/json image/svg+xml
</IfModule>

# ------------------------------------------------------------------
# Big file uploads (if your host allows it)
# ------------------------------------------------------------------
<IfModule mod_php.c>
    php_value upload_max_filesize 150M
    php_value post_max_size 160M
    php_value max_execution_time 300
    php_value memory_limit 256M
</IfModule>

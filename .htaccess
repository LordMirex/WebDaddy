# .htaccess – FINAL PRODUCTION VERSION (Performance + Security + Correct Routing)
Options -Indexes
DirectoryIndex index.php index.html

# Add MIME types for web manifest and feeds
AddType application/manifest+json .webmanifest
AddType application/atom+xml .atom
AddType application/rss+xml .rss

# ------------------------------------------------------------------
# 1. Force HTTPS + non-www (dynamic domain handling)
# ------------------------------------------------------------------
RewriteEngine On
RewriteBase /

RewriteCond %{HTTPS} off
RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301,NE]

RewriteCond %{HTTP_HOST} ^www\. [NC]
RewriteCond %{HTTP_HOST} ^www\.(.+)$ [NC]
RewriteRule ^ https://%1%{REQUEST_URI} [L,R=301,NE]

# ------------------------------------------------------------------
# 2. Remove trailing slashes (except real directories)
# ------------------------------------------------------------------
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.+)/$ /$1 [R=301,L]

# ------------------------------------------------------------------
# 3. Block sensitive directories
# ------------------------------------------------------------------
RewriteRule ^(includes|database|uploads/private)/ - [F,L]

# ------------------------------------------------------------------
# 4. Serve REAL files & folders directly (CSS, JS, images, assets/, admin/, api/, etc.)
# ------------------------------------------------------------------
RewriteCond %{REQUEST_FILENAME} -f [OR]
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]

# ------------------------------------------------------------------
# 5. Robots.txt routing
# ------------------------------------------------------------------
RewriteRule ^robots\.txt$ robots.php [L]
RewriteRule ^robots/?$ robots.php [L]

# ------------------------------------------------------------------
# 6. Sitemap routing
# ------------------------------------------------------------------
RewriteRule ^sitemap\.xml$ sitemap.php [L]
RewriteRule ^sitemap/?$ sitemap.php [L]

# ------------------------------------------------------------------
# 7. Tool detail page routing: /tool/slug-name → index.php?tool=slug-name
#    (Tools open as modals on index page, not a separate page)
# ------------------------------------------------------------------
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^tool/([a-zA-Z0-9\-_]+)/?$ index.php?tool=$1 [QSA,L]

# ------------------------------------------------------------------
# 8. Template slug routing → template.php?slug=name
#     (only triggers if file/folder doesn't exist)
#     Matches single slug path: /slug-name (but not /slug/path or special dirs)
# ------------------------------------------------------------------
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/(admin|affiliate|assets|api|uploads|mailer|legal|index|template|sitemap|tool|robots|favicon|\.well-known) [NC]
RewriteRule ^([a-zA-Z0-9_-]+)/?$ template.php?slug=$1 [QSA,L]

# ------------------------------------------------------------------
# 9. Everything else → index.php (root / and catch-all)
# ------------------------------------------------------------------
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^ index.php [QSA,L]

# ------------------------------------------------------------------
# Security: Deny sensitive files
# ------------------------------------------------------------------
<FilesMatch "\.(env|sql|bak|log|ini|conf|yml|yaml|sh|bat|md|git|htaccess|php~)$">
    Require all denied
</FilesMatch>

# ------------------------------------------------------------------
# Security Headers (same as your original + improved CSP)
# ------------------------------------------------------------------
<IfModule mod_headers.c>
    Header set X-Content-Type-Options "nosniff"
    Header set X-Frame-Options "SAMEORIGIN"
    Header set X-XSS-Protection "1; mode=block"
    Header set Referrer-Policy "strict-origin-when-cross-origin"
    Header set Strict-Transport-Security "max-age=31536000; includeSubDomains" env=HTTPS
    
    # Your original CSP + added blob: for some JS features + googletagmanager if you use analytics
    Header set Content-Security-Policy "default-src 'self' https://cdn.jsdelivr.net https://wa.me; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdn.tailwindcss.com https://www.googletagmanager.com; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdn.tailwindcss.com https://fonts.googleapis.com; img-src 'self' data: https: blob:; font-src 'self' https://cdn.jsdelivr.net https://fonts.googleapis.com https://fonts.gstatic.com; frame-ancestors 'self';"
</IfModule>

# ------------------------------------------------------------------
# Aggressive Caching (1 year + immutable) – EXACTLY like your old one
# ------------------------------------------------------------------
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresDefault "access plus 1 month"

    ExpiresByType text/css                      "access plus 1 year"
    ExpiresByType application/javascript        "access plus 1 year"
    ExpiresByType image/svg+xml                 "access plus 1 year"
    ExpiresByType image/webp                    "access plus 1 year"
    ExpiresByType image/png                     "access plus 1 year"
    ExpiresByType image/jpeg                    "access plus 1 year"
    ExpiresByType image/gif                     "access plus 1 year"
    ExpiresByType video/mp4                     "access plus 1 year"
    ExpiresByType font/woff2                    "access plus 1 year"
    ExpiresByType font/woff                     "access plus 1 year"
</IfModule>

<IfModule mod_headers.c>
    <FilesMatch "\.(css|js|woff2?|ttf|otf|svg|png|jpe?g|gif|webp|ico|mp4|webm)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </FilesMatch>
    <FilesMatch "\.(php|html?)$">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
    </FilesMatch>
</IfModule>

# ------------------------------------------------------------------
# Gzip Compression
# ------------------------------------------------------------------
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/css application/javascript application/json image/svg+xml
</IfModule>

# ------------------------------------------------------------------
# Big file uploads (if your host allows it)
# ------------------------------------------------------------------
<IfModule mod_php.c>
    php_value upload_max_filesize 150M
    php_value post_max_size 160M
    php_value max_execution_time 300
    php_value memory_limit 256M
</IfModule>

# Optimize logo loading
<FilesMatch "webdaddy-logo\.png$">
    Header set Cache-Control "public, max-age=31536000, immutable"
    Header set Expires "Sun, 22 Nov 2026 21:05:00 GMT"
</FilesMatch>
